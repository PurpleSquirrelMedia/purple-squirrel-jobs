generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// WAITLIST & USERS
// ============================================

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  userType  UserType
  createdAt DateTime @default(now())
  converted Boolean  @default(false)
}

enum UserType {
  CANDIDATE
  EMPLOYER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  avatar        String?
  userType      UserType
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  candidate     Candidate?
  company       Company?
  applications  Application[]
}

// ============================================
// CANDIDATES
// ============================================

model Candidate {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Profile
  headline        String?
  bio             String?  @db.Text
  location        String?
  remoteOnly      Boolean  @default(false)
  openToWork      Boolean  @default(true)

  // Experience
  yearsExperience Int?
  currentTitle    String?
  currentCompany  String?

  // Salary expectations
  salaryMin       Int?
  salaryMax       Int?
  salaryCurrency  String   @default("USD")

  // Job preferences
  desiredRoles    String[]
  desiredLocations String[]

  // Resume & links
  resumeUrl       String?
  linkedinUrl     String?
  githubUrl       String?
  portfolioUrl    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  skills          CandidateSkill[]
  experiences     Experience[]
  education       Education[]
  applications    Application[]
  savedJobs       SavedJob[]
  jobMatches      JobMatch[]
}

model CandidateSkill {
  id          String    @id @default(cuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  skillId     String
  skill       Skill     @relation(fields: [skillId], references: [id])
  level       SkillLevel?
  yearsUsed   Int?

  @@unique([candidateId, skillId])
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Experience {
  id          String    @id @default(cuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  title       String
  company     String
  location    String?
  startDate   DateTime
  endDate     DateTime?
  current     Boolean   @default(false)
  description String?   @db.Text
}

model Education {
  id          String    @id @default(cuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  institution String
  degree      String?
  field       String?
  startDate   DateTime?
  endDate     DateTime?
  current     Boolean   @default(false)
}

// ============================================
// COMPANIES & JOBS
// ============================================

model Company {
  id          String   @id @default(cuid())
  userId      String?  @unique
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  name        String
  slug        String   @unique
  description String?  @db.Text
  website     String?
  logoUrl     String?
  size        CompanySize?
  industry    String?
  location    String?

  // Verification
  verified    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  jobs        Job[]
}

enum CompanySize {
  STARTUP     // 1-10
  SMALL       // 11-50
  MEDIUM      // 51-200
  LARGE       // 201-1000
  ENTERPRISE  // 1000+
}

model Job {
  id              String     @id @default(cuid())
  companyId       String
  company         Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Basic info
  title           String
  slug            String
  description     String     @db.Text

  // Location & type
  location        String?
  remote          RemoteType @default(ONSITE)
  employmentType  EmploymentType @default(FULL_TIME)

  // Compensation
  salaryMin       Int?
  salaryMax       Int?
  salaryCurrency  String     @default("USD")
  salaryPeriod    SalaryPeriod @default(YEARLY)
  showSalary      Boolean    @default(true)
  equity          String?

  // Requirements
  experienceMin   Int?
  experienceMax   Int?

  // Status
  status          JobStatus  @default(ACTIVE)
  featured        Boolean    @default(false)

  // Source info (for aggregation)
  sourceUrl       String?
  sourcePlatform  String?
  externalId      String?

  // Timestamps
  postedAt        DateTime   @default(now())
  expiresAt       DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  skills          JobSkill[]
  applications    Application[]
  savedBy         SavedJob[]
  matches         JobMatch[]

  @@unique([companyId, slug])
  @@unique([sourcePlatform, externalId])
  @@index([status, postedAt])
  @@index([location])
  @@index([remote])
}

enum RemoteType {
  ONSITE
  HYBRID
  REMOTE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  FREELANCE
  INTERNSHIP
}

enum SalaryPeriod {
  HOURLY
  MONTHLY
  YEARLY
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  FILLED
}

model JobSkill {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  skillId   String
  skill     Skill    @relation(fields: [skillId], references: [id])
  required  Boolean  @default(true)

  @@unique([jobId, skillId])
}

// ============================================
// SKILLS (Shared taxonomy)
// ============================================

model Skill {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  category    String?

  // Relations
  candidates  CandidateSkill[]
  jobs        JobSkill[]
}

// ============================================
// APPLICATIONS & MATCHING
// ============================================

model Application {
  id          String            @id @default(cuid())
  candidateId String
  candidate   Candidate         @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobId       String
  job         Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      ApplicationStatus @default(PENDING)
  coverLetter String?           @db.Text
  resumeUrl   String?

  // AI Match score
  matchScore  Float?

  appliedAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([candidateId, jobId])
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  INTERVIEWING
  OFFERED
  HIRED
  REJECTED
  WITHDRAWN
}

model SavedJob {
  id          String    @id @default(cuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  savedAt     DateTime  @default(now())

  @@unique([candidateId, jobId])
}

model JobMatch {
  id          String    @id @default(cuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  score       Float
  reasoning   String?   @db.Text

  // Was this surfaced to the candidate?
  shown       Boolean   @default(false)
  shownAt     DateTime?

  // Did they act on it?
  dismissed   Boolean   @default(false)
  applied     Boolean   @default(false)

  createdAt   DateTime  @default(now())

  @@unique([candidateId, jobId])
  @@index([candidateId, score])
}
